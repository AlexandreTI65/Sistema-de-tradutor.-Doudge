<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tradutor T√©cnico ‚Äî Azure AI</title>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg-primary: #f8fafc;
      --bg-card: white;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --border-focus: #6366f1;
      --shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    }
    
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--text-primary); 
      padding: 20px; 
      margin: 0;
      min-height: 100vh;
    }
    
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      background: var(--bg-card); 
      border-radius: 16px; 
      padding: 30px; 
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    
    h1 { 
      margin: 0 0 20px; 
      font-size: 28px; 
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
    }
    
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }
    
    .input-section, .output-section {
      display: flex;
      flex-direction: column;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    textarea { 
      width: 100%; 
      height: 300px; 
      padding: 16px; 
      border-radius: 12px; 
      border: 2px solid var(--border); 
      resize: vertical; 
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s ease;
      background: #fafbfc;
    }
    
    textarea:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .controls { 
      display: flex; 
      gap: 15px; 
      flex-wrap: wrap; 
      margin: 20px 0; 
      align-items: center;
      background: #f8fafc;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    
    select, input[type="text"], input[type="file"] { 
      padding: 10px 14px; 
      border-radius: 8px; 
      border: 1px solid var(--border); 
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    button { 
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 8px; 
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    button:hover:not([disabled]) { 
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    button[disabled] { 
      opacity: 0.6; 
      cursor: not-allowed; 
      transform: none !important;
    }
    
    .btn-success { background: var(--success); }
    .btn-success:hover:not([disabled]) { background: #059669; }
    
    .btn-danger { background: var(--danger); }
    .btn-danger:hover:not([disabled]) { background: #dc2626; }
    
    .result { 
      margin-top: 12px; 
      background: #fafbfc; 
      padding: 20px; 
      border-radius: 12px; 
      border: 2px solid var(--border); 
      min-height: 300px; 
      white-space: pre-wrap;
      font-family: inherit;
      line-height: 1.6;
    }
    
    .small { font-size: 13px; color: var(--text-secondary); }
    label { font-size: 14px; font-weight: 500; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    
    .stats {
      display: flex;
      gap: 20px;
      margin: 15px 0;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .stat-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }
    
    @media (max-width: 768px) {
      .main-grid { grid-template-columns: 1fr; }
      .container { padding: 20px; margin: 10px; }
      h1 { font-size: 24px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üåê Tradutor de Artigos T√©cnicos ‚Äî Azure AI</h1>
    <div class="small" style="text-align: center; margin-bottom: 20px;">
      Cole o texto t√©cnico abaixo. Configure termos t√©cnicos para preservar durante a tradu√ß√£o.
    </div>

    <div class="main-grid">
      <div class="input-section">
        <div class="section-title">
          üìù Texto Original
          <span class="stats" id="inputStats">
            <span class="stat-item">üìä <span id="charCount">0</span> caracteres</span>
            <span class="stat-item">üìÑ <span id="wordCount">0</span> palavras</span>
          </span>
        </div>
        <textarea id="sourceText" placeholder="Cole o artigo t√©cnico aqui ou carregue um arquivo..."></textarea>
      </div>

      <div class="output-section">
        <div class="section-title">
          üéØ Tradu√ß√£o
          <span class="stats" id="outputStats" style="display: none;">
            <span class="stat-item">‚è±Ô∏è <span id="translationTime">0</span>s</span>
            <span class="stat-item">üîÑ <span id="preservedTerms">0</span> termos preservados</span>
          </span>
        </div>
        <div id="result" class="result">Aqui aparecer√° a tradu√ß√£o...</div>
      </div>
    </div>

    <div class="controls">
      <div class="row">
        <label for="langFrom">üî§ De:</label>
        <select id="langFrom">
          <option value="auto">Detectar automaticamente</option>
          <option value="pt">Portugu√™s</option>
          <option value="en">Ingl√™s</option>
          <option value="es">Espanhol</option>
          <option value="fr">Franc√™s</option>
          <option value="de">Alem√£o</option>
          <option value="ja">Japon√™s</option>
          <option value="zh">Chin√™s</option>
          <option value="ru">Russo</option>
        </select>
      </div>

      <div class="row">
        <label for="langTo">üéØ Para:</label>
        <select id="langTo">
          <option value="pt">Portugu√™s</option>
          <option value="en">Ingl√™s</option>
          <option value="es">Espanhol</option>
          <option value="fr">Franc√™s</option>
          <option value="de">Alem√£o</option>
          <option value="ja">Japon√™s</option>
          <option value="zh">Chin√™s</option>
          <option value="ru">Russo</option>
        </select>
      </div>

      <div class="row">
        <label for="gloss">üîí Preservar termos:</label>
        <input id="gloss" type="text" placeholder="ex: API, cloud computing, machine learning, Kubernetes" style="min-width:300px" />
      </div>

      <div class="row">
        <button id="translateBtn">
          <span id="translateIcon">üöÄ</span>
          <span id="translateText">Traduzir</span>
        </button>
        <button id="clearBtn" class="btn-danger">üóëÔ∏è Limpar</button>
        <button id="copyBtn" class="btn-success">üìã Copiar</button>
        <button id="downloadBtn" class="btn-success" style="display: none;">üíæ Baixar</button>
      </div>
    </div>

  </div>

<script>
/*
  --- CONFIGURA√á√ÉO (substitua ENDPOINT e se necess√°rio REGION) ---
  - ENDPOINT: normalmente √© algo como https://<seu-recurso>.cognitiveservices.azure.com
  - API_KEY: voc√™ forneceu a chave; ela est√° inserida abaixo (aten√ß√£o √† exposi√ß√£o)
  - REGION: algumas contas exigem o header 'Ocp-Apim-Subscription-Region' (ex: 'eastus', 'brazilsouth')
*/

// CONFIGURA√á√ÉO: Azure Translator (chave ofuscada para seguran√ßa)
const ENDPOINT = "https://api.cognitive.microsofttranslator.com"; 
// Chave decodificada automaticamente
const API_KEY = atob("MWZhUHhoMHU1NkJvM3g4dnFCY0pyd3FyYlNFUUJUOWh4VWt4bDV1MlpQSUxYWTdaOHBQWEpRUUo5OUJKQUNIWUh2NlhKM3czQUFBRUFDT0dxMUhq");
const REGION = atob("ZWFzdHVzMg=="); // eastus2

// UI Elements
const sourceEl = document.getElementById('sourceText');
const langFrom = document.getElementById('langFrom');
const langTo = document.getElementById('langTo');
const glossEl = document.getElementById('gloss');
const translateBtn = document.getElementById('translateBtn');
const translateIcon = document.getElementById('translateIcon');
const translateText = document.getElementById('translateText');
const resultEl = document.getElementById('result');
const clearBtn = document.getElementById('clearBtn');
const copyBtn = document.getElementById('copyBtn');
const downloadBtn = document.getElementById('downloadBtn');
const charCount = document.getElementById('charCount');
const wordCount = document.getElementById('wordCount');
const translationTime = document.getElementById('translationTime');
const preservedTerms = document.getElementById('preservedTerms');
const outputStats = document.getElementById('outputStats');

// State
let translationStartTime = 0;
let lastTranslation = '';

// Event Listeners
sourceEl.addEventListener('input', updateInputStats);
sourceEl.addEventListener('paste', () => setTimeout(updateInputStats, 100));

translateBtn.addEventListener('click', () => doTranslate());

clearBtn.addEventListener('click', () => {
  sourceEl.value = "";
  resultEl.textContent = "Aqui aparecer√° a tradu√ß√£o...";
  glossEl.value = "";
  lastTranslation = '';
  updateInputStats();
  outputStats.style.display = 'none';
  downloadBtn.style.display = 'none';
  showToast('üóëÔ∏è Conte√∫do limpo', 'success');
});

copyBtn.addEventListener('click', async () => {
  if (!lastTranslation) {
    showToast('‚ùå Nada para copiar', 'error');
    return;
  }
  
  try {
    await navigator.clipboard.writeText(lastTranslation);
    showToast('üìã Copiado para a √°rea de transfer√™ncia!', 'success');
  } catch (error) {
    showToast('‚ùå Falha ao copiar', 'error');
  }
});

downloadBtn.addEventListener('click', () => {
  if (!lastTranslation) return;
  
  const blob = new Blob([lastTranslation], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `traducao_${new Date().toISOString().slice(0,10)}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('üíæ Arquivo baixado!', 'success');
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey || e.metaKey) {
    switch(e.key) {
      case 'Enter':
        e.preventDefault();
        doTranslate();
        break;
      case 'l':
        e.preventDefault();
        clearBtn.click();
        break;
    }
  }
});

// Initialize
updateInputStats();

// Utility Functions
function updateInputStats() {
  const text = sourceEl.value;
  const chars = text.length;
  const words = text.trim() ? text.trim().split(/\s+/).length : 0;
  
  charCount.textContent = chars.toLocaleString();
  wordCount.textContent = words.toLocaleString();
}

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 3000);
}

function setTranslateButtonState(loading) {
  translateBtn.disabled = loading;
  if (loading) {
    translateIcon.innerHTML = '<div class="loading"></div>';
    translateText.textContent = 'Traduzindo...';
  } else {
    translateIcon.textContent = 'üöÄ';
    translateText.textContent = 'Traduzir';
  }
}

async function doTranslate() {
  const text = sourceEl.value.trim();
  if (!text) { 
    showToast('‚ùå Digite algum texto para traduzir', 'error');
    return;
  }
  
  translationStartTime = Date.now();
  setTranslateButtonState(true);
  
  try {
    const termsRaw = glossEl.value.trim();
    const terms = termsRaw ? termsRaw.split(',').map(s => s.trim()).filter(Boolean) : [];
    
    showToast('üîÑ Iniciando tradu√ß√£o...', 'success');
    
    const prepared = prepareTextWithTokens(text, terms);
    const fromLang = langFrom.value === 'auto' ? undefined : langFrom.value;
    const translated = await callAzureTranslate(prepared.modifiedText, langTo.value, fromLang);
    const final = restoreTokens(translated, prepared.tokens);
    
    // Update results
    lastTranslation = final;
    resultEl.textContent = final;
    
    // Update stats
    const timeElapsed = ((Date.now() - translationStartTime) / 1000).toFixed(1);
    translationTime.textContent = timeElapsed;
    preservedTerms.textContent = terms.length;
    outputStats.style.display = 'flex';
    downloadBtn.style.display = 'flex';
    
    showToast('‚úÖ Tradu√ß√£o conclu√≠da!', 'success');
    
  } catch (err) {
    console.error(err);
    showToast(`‚ùå Erro na tradu√ß√£o: ${err.message}`, 'error');
    resultEl.textContent = `Erro na tradu√ß√£o: ${err.message}\n\nVerifique sua conex√£o e configura√ß√µes da API.`;
  } finally {
    setTranslateButtonState(false);
  }
}

/* 1) substitui termos por tokens para preservar */
function prepareTextWithTokens(text, terms){
  const tokens = {};
  let modified = text;
  terms.forEach((term, idx) => {
    if (!term) return;
    // token √∫nico
    const token = `__PMD_TERM_${idx}__`;
    tokens[token] = term;
    // substituir todas as ocorr√™ncias (usando regex com escape)
    const pattern = new RegExp(escapeRegExp(term), 'gi');
    modified = modified.replace(pattern, token);
  });
  return { modifiedText: modified, tokens };
}

/* 2) restaura tokens no texto traduzido */
function restoreTokens(translatedText, tokens){
  let out = translatedText;
  Object.entries(tokens).forEach(([token, original]) => {
    out = out.split(token).join(original);
  });
  return out;
}

function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

/* Faz a chamada √† API Translator v3 */
async function callAzureTranslate(text, toLang, fromLang = null) {
  // Construct URL with parameters
  let url = `${ENDPOINT}/translate?api-version=3.0&to=${encodeURIComponent(toLang)}`;
  if (fromLang) {
    url += `&from=${encodeURIComponent(fromLang)}`;
  }

  const body = [{ Text: text }];

  const headers = {
    'Content-Type': 'application/json',
    'Ocp-Apim-Subscription-Key': API_KEY,
    'Ocp-Apim-Subscription-Region': REGION
  };

  console.log('üåê Fazendo chamada para:', url);
  console.log('üìä Tamanho do texto:', text.length, 'caracteres');

  const resp = await fetch(url, {
    method: 'POST',
    headers,
    body: JSON.stringify(body)
  });

  if (!resp.ok) {
    const textErr = await resp.text();
    console.error('‚ùå Erro da API:', resp.status, resp.statusText, textErr);
    
    let errorMsg = `Erro ${resp.status}: ${resp.statusText}`;
    if (resp.status === 401) {
      errorMsg = 'Chave da API inv√°lida ou expirada';
    } else if (resp.status === 403) {
      errorMsg = 'Acesso negado - verifique as configura√ß√µes da conta';
    } else if (resp.status === 429) {
      errorMsg = 'Muitas requisi√ß√µes - aguarde um momento';
    } else if (resp.status >= 500) {
      errorMsg = 'Erro no servidor Azure - tente novamente';
    }
    
    throw new Error(errorMsg);
  }

  const data = await resp.json();
  console.log('‚úÖ Resposta recebida:', data);

  if (!Array.isArray(data) || !data[0]?.translations?.[0]?.text) {
    throw new Error('Resposta inesperada da API: ' + JSON.stringify(data));
  }

  // Log detected language if auto-detection was used
  if (!fromLang && data[0].detectedLanguage) {
    console.log('üîç Idioma detectado:', data[0].detectedLanguage.language, 
                '(confian√ßa:', data[0].detectedLanguage.score, ')');
  }

  return data[0].translations[0].text;
}
</script>
</body>
</html>
